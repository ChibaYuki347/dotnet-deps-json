# å®Œå…¨ãªè‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ä½œæˆã§è‡ªå‹•çš„ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’é…å¸ƒã—ã€deps.jsonå¤‰åŒ–ã‚’è¨˜éŒ²

name: Automated Release and Package Distribution

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚¿ã‚°æ¯”è¼ƒç”¨ï¼‰
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Configure NuGet for CI/CD
      run: |
        # CI/CDç”¨ã®nuget.configã‚’ä½œæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰é™¤å¤–ï¼‰
        cat > nuget.config << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <configuration>
          <packageSources>
            <add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />
            <add key="github-packages" value="https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" protocolVersion="3" />
          </packageSources>
          <packageSourceCredentials>
            <github-packages>
              <add key="Username" value="${{ github.actor }}" />
              <add key="ClearTextPassword" value="${{ secrets.GITHUB_TOKEN }}" />
            </github-packages>
          </packageSourceCredentials>
        </configuration>
        EOF
    
    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --configuration Release --no-restore
    
    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal
    
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æ³¨å…¥ï¼‰
    - name: Pack CommonFramework with version
      run: |
        dotnet pack src/CommonFramework/CommonFramework.csproj \
          --configuration Release \
          --no-build \
          --output ./release-packages/ \
          -p:PackageVersion=${{ steps.get_version.outputs.version }} \
          -p:AssemblyVersion=${{ steps.get_version.outputs.version }} \
          -p:FileVersion=${{ steps.get_version.outputs.version }}
    
    # GitHub Packagesã«å…¬é–‹
    - name: Publish to GitHub Packages
      run: |
        dotnet nuget push ./release-packages/*.nupkg \
          --api-key ${{ secrets.GITHUB_TOKEN }} \
          --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
          --skip-duplicate
    
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å…¬é–‹å¾Œã€DepsJsonDemoã«CommonFrameworkã‚’è¿½åŠ 
    - name: Update DepsJsonDemo to use published package
      run: |
        cd src/DepsJsonDemo
        dotnet add package CommonFramework --version ${{ steps.get_version.outputs.version }} --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        cd ../..
        
        # æ›´æ–°ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        dotnet build src/DepsJsonDemo/DepsJsonDemo.csproj --configuration Release
        dotnet publish src/DepsJsonDemo/DepsJsonDemo.csproj --configuration Release --output ./publish-demo
    
    # ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§æ–°ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ†ã‚¹ãƒˆ
    - name: Test with published package
      run: |
        # DepsJsonDemoã‚’ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        echo "ðŸ“Š Published Package Integration Test:"
        cd ./publish-demo
        ./DepsJsonDemo
        cd ..
        
        # deps.jsonè§£æž
        echo "ðŸ“Š Published Package deps.json Analysis:"
        dotnet run --project src/DependencyAnalyzer/DependencyAnalyzer.csproj -- --file ./publish-demo/DepsJsonDemo.deps.json --verbose
    
    # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        # Release ${{ steps.get_version.outputs.tag }}
        
        ## ðŸ“¦ Published Packages
        - CommonFramework v${{ steps.get_version.outputs.version }}
        
        ## ðŸ” deps.json Analysis Results
        This release includes comprehensive deps.json structure analysis for:
        - Package reference integration
        - Dependency resolution verification
        - SHA512 hash validation
        
        ## ðŸš€ Installation
        ```bash
        dotnet add package CommonFramework --version ${{ steps.get_version.outputs.version }} --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        ```
        
        ## ðŸ“‹ Changes in this Release
        $(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" || echo "- Initial release")
        EOF
        
        echo "Generated release notes:"
        cat release_notes.md
    
    # GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Release ${{ steps.get_version.outputs.tag }}
        body_path: release_notes.md
        files: |
          ./release-packages/*.nupkg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-${{ steps.get_version.outputs.version }}
        path: |
          ./release-packages/
          ./publish-demo/
        retention-days: 90
